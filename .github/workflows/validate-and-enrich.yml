name: 'Validate and Comment on PR'

on:
  pull_request_target:
    types: [opened, synchronize]
    paths:
      - 'rsc/submissions/**'

permissions:
  contents: write
  pull-requests: write
  checks: write

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: 'Blacklist Check'
        id: blacklist_check
        env:
          BLACKLIST: "" # Add comma-separated usernames to ban.
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
        run: |
          echo "PR Author: $PR_AUTHOR"
          if [[ ",$BLACKLIST," == *",$PR_AUTHOR,"* ]]; then
            echo "::error::User $PR_AUTHOR is on the blacklist."
            exit 1
          else
            echo "User $PR_AUTHOR is not on the blacklist."
          fi

      - name: 'Checkout PR Code Safely'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0 # Fetch all history to make base.sha available for git diff

      - name: 'Check for Duplicate Entries'
        id: duplicate_check
        run: |
          # Get the list of files changed in the PR
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }})
          SUBMISSION_FILE=$(echo "$CHANGED_FILES" | grep '^rsc/submissions/.*\.json$' | head -n 1)
          echo "submission_file=$SUBMISSION_FILE" >> "$GITHUB_OUTPUT"

          if [[ -z "$SUBMISSION_FILE" ]]; then
            echo "No submission file found."
            exit 0
          fi

          # Run the duplicate check script
          node scripts/check-duplicates.mjs "$SUBMISSION_FILE" >> "$GITHUB_OUTPUT"

      - name: Create Check Run
        if: always()
        run: |
          if [[ "${{ steps.duplicate_check.outputs.duplicate_found }}" == "true" ]]; then
            CONCLUSION="failure"
            TITLE="Submission Denied: Duplicate Found"
            SUMMARY="A duplicate entry was found in your submission. See the PR comment for details."
          else
            CONCLUSION="success"
            TITLE="Validation Successful"
            SUMMARY="No duplicate entries found."
          fi

          JSON_PAYLOAD=$(jq -n \
            --arg name "Duplicate Entry Check" \
            --arg head_sha "${{ github.event.pull_request.head.sha }}" \
            --arg status "completed" \
            --arg conclusion "$CONCLUSION" \
            --arg title "$TITLE" \
            --arg summary "$SUMMARY" \
            '{ 
              name: $name, 
              head_sha: $head_sha, 
              status: $status, 
              conclusion: $conclusion, 
              output: { 
                title: $title, 
                summary: $summary 
              } 
            }')

          curl -L --fail \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${{ github.repository }}/check-runs" \
            -d "$JSON_PAYLOAD"

      - name: 'Generate Success Comment Body'
        id: success_comment
        if: steps.duplicate_check.outputs.duplicate_found != 'true' && steps.duplicate_check.outputs.submission_file != ''
        run: |
          body=$(node scripts/decode-for-validation.mjs ${{ steps.duplicate_check.outputs.submission_file }})
          delimiter=$(openssl rand -hex 8)
          echo "body<<$delimiter" >> $GITHUB_OUTPUT
          echo "$body" >> $GITHUB_OUTPUT
          echo "$delimiter" >> $GITHUB_OUTPUT

      - name: 'Generate Denied Comment Body'
        id: denied_comment
        if: steps.duplicate_check.outputs.duplicate_found == 'true' && steps.duplicate_check.outputs.submission_file != ''
        run: |
          body=$(node scripts/generate-denied-comment.mjs ${{ steps.duplicate_check.outputs.submission_file }})
          delimiter=$(openssl rand -hex 8)
          echo "body<<$delimiter" >> $GITHUB_OUTPUT
          echo "$body" >> $GITHUB_OUTPUT
          echo "$delimiter" >> $GITHUB_OUTPUT

      - name: 'Post PR Comment'
        uses: actions/github-script@v7
        if: always() && (steps.success_comment.outputs.body != '' || steps.denied_comment.outputs.body != '')
        env:
          COMMENT_BODY: ${{ steps.success_comment.outputs.body || steps.denied_comment.outputs.body }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const body = process.env.COMMENT_BODY;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
