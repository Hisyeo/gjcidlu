name: 'Validate and Comment on PR'

on:
  pull_request_target:
    types: [opened, synchronize]
    paths:
      - 'rsc/submitted/**'

permissions:
  contents: read
  pull-requests: write

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: 'Blacklist Check'
        id: blacklist_check
        env:
          BLACKLIST: "" # Add comma-separated usernames to ban.
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
        run: |
          echo "PR Author: $PR_AUTHOR"
          if [[ ",$BLACKLIST," == *",$PR_AUTHOR,"* ]]; then
            echo "::error::User $PR_AUTHOR is on the blacklist."
            exit 1
          else
            echo "User $PR_AUTHOR is not on the blacklist."
          fi

      - name: 'Checkout PR Code Safely'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: 'Generate Comment Body'
        id: generate_comment
        run: |
          SUBMISSION_FILE=$(find rsc/submitted -name '*.json' -print -quit)
          if [[ -z "$SUBMISSION_FILE" ]]; then
            echo "comment_body=This PR does not contain a submission file." >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # The jq utility is pre-installed on GitHub runners
          SUBMISSION_CONTENT=$(cat "$SUBMISSION_FILE")
          USER_SYSTEM=$(echo "$SUBMISSION_CONTENT" | jq -r '.author.system')
          USER_ID=$(echo "$SUBMISSION_CONTENT" | jq -r '.author.id')
          NEW_TERMS_COUNT=$(echo "$SUBMISSION_CONTENT" | jq '.newTerms | length')
          NEW_ENTRIES_COUNT=$(echo "$SUBMISSION_CONTENT" | jq '.newEntries | length')
          VOTES_COUNT=$(echo "$SUBMISSION_CONTENT" | jq '.votes | length')

          # Generate receipt list
          RECEIPT_ITEMS=$(echo "$SUBMISSION_CONTENT" | jq -r '
            (.newTerms // []) | map("- Term '\''\(.id | split("-")[0])'\''") | .[],
            (.newEntries // []) | map("- Translation '\''\(.id)'\'' for '\''\(.termId)'\''") | .[],
            (.votes // []) | map("- \(.voteType | cap) vote for '\''\(.entryId)'\'' on term '\''\(.termId)'\''") | .[]
          ' | sed 's/^/  /')

          # Generate verification link
          if [[ "$USER_SYSTEM" == "Email" ]]; then
            EMAIL_BODY="Thank you for your ${VOTES_COUNT} votes, ${NEW_ENTRIES_COUNT} entries, and ${NEW_TERMS_COUNT} terms!%0A%0AHere is a receipt of what you have submitted:%0A${RECEIPT_ITEMS//'%'/'%25'//''/'%0A'//' '/'%20'//'"'/"%27"}%0A%0AReply YES if you confirm these votes, entries and terms to be valid.%0AReply NO if you would like to start over.%0AIf we don't receive a reply in a timely fashion, you may become banned from using email verification."
            VERIFICATION_LINK="mailto:${USER_ID}?subject=Confirm Your Submission&body=${EMAIL_BODY}"
          else
            VERIFICATION_LINK="https://discord.com/users/${USER_ID}"
          fi

          COMMENT_BODY="### Submission Review Required üó≥Ô∏è\n\n"
          COMMENT_BODY+="A new submission has been received from **${USER_SYSTEM}** user \`${USER_ID}\`.\n\n"
          COMMENT_BODY+="#### Summary of Contributions\n- **New Terms:** ${NEW_TERMS_COUNT}\n- **New Translations:** ${NEW_ENTRIES_COUNT}\n- **New Votes:** ${VOTES_COUNT}\n\n"
          COMMENT_BODY+="---\n\n#### Reviewer Action\n\nClick here to verify the user: [**Verify via ${USER_SYSTEM}**](${VERIFICATION_LINK})\n\n"
          COMMENT_BODY+="<details><summary>Click to see full submission receipt</summary>\n\n${RECEIPT_ITEMS}\n\n</details>"

          # Escape for multiline output
          echo "comment_body<<EOF" >> "$GITHUB_OUTPUT"
          echo -e "$COMMENT_BODY" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: 'Post PR Comment'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: ${{ steps.generate_comment.outputs.comment_body }}
          token: ${{ secrets.GITHUB_TOKEN }}
