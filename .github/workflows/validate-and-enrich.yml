name: 'Validate and Comment on PR'

on:
  pull_request_target:
    types: [opened, synchronize]
    paths:
      - 'rsc/submitted/**'

permissions:
  contents: write
  pull-requests: write
  checks: write

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: 'Blacklist Check'
        id: blacklist_check
        env:
          BLACKLIST: "" # Add comma-separated usernames to ban.
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
        run: |
          echo "PR Author: $PR_AUTHOR"
          if [[ ",$BLACKLIST," == *",$PR_AUTHOR,"* ]]; then
            echo "::error::User $PR_AUTHOR is on the blacklist."
            exit 1
          else
            echo "User $PR_AUTHOR is not on the blacklist."
          fi

      - name: 'Checkout PR Code Safely'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0 # Fetch all history to make base.sha available for git diff

      - name: 'Check for Duplicate Entries'
        id: duplicate_check
        run: |
          # Get the list of files changed in the PR
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }})
          SUBMISSION_FILE=$(echo "$CHANGED_FILES" | grep '^rsc/submitted/.*\.json$' | head -n 1)
          echo "submission_file=$SUBMISSION_FILE" >> "$GITHUB_OUTPUT"

          if [[ -z "$SUBMISSION_FILE" ]]; then
            echo "No submission file found."
            exit 0
          fi

          # Run the duplicate check script
          node scripts/check-duplicates.mjs "$SUBMISSION_FILE" >> "$GITHUB_OUTPUT"

      - name: Create Check Run
        if: always() # Always run this step to report success or failure
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [[ "${{ steps.duplicate_check.outputs.duplicate_found }}" == "true" ]]; then
            CONCLUSION="action_required"
            TITLE="Duplicate Entry Found"
            SUMMARY="Your translation **${{ steps.duplicate_check.outputs.duplicate_entry_id }}** has already been submitted in [another submission](${{ github.server_url }}/${{ github.repository }}/blob/${{ github.event.pull_request.head.sha }}/${{ steps.duplicate_check.outputs.duplicate_submission_file }})."
            TEXT="To resolve this, please comment on this PR with one of the following commands:\\\n- \\\`/change-to-vote\\\`\\\n- \\\`/remove-entry\\\`"
            ACTIONS="[]"
          else
            CONCLUSION="success"
            TITLE="Validation Successful"
            SUMMARY="No duplicate entries found."
            TEXT="This submission is ready for review."
            ACTIONS="[]"
          fi

          JSON_PAYLOAD=$(jq -n \
            --arg name "Duplicate Entry Check" \
            --arg head_sha "${{ github.event.pull_request.head.sha }}" \
            --arg status "completed" \
            --arg conclusion "$CONCLUSION" \
            --arg title "$TITLE" \
            --arg summary "$SUMMARY" \
            --arg text "$TEXT" \
            --argjson actions "$ACTIONS" \
            '{
              name: $name,
              head_sha: $head_sha,
              status: $status,
              conclusion: $conclusion,
              output: {
                title: $title,
                summary: $summary,
                text: $text
              },
              actions: $actions
            }')

          curl -L --fail \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${{ github.repository }}/check-runs" \
            -d "$JSON_PAYLOAD"

      - name: 'Generate PR Comment Body'
        id: comment_body
        if: steps.duplicate_check.outputs.duplicate_found != 'true' && steps.duplicate_check.outputs.submission_file != ''
        run: |
          body=$(node scripts/decode-for-validation.mjs ${{ steps.duplicate_check.outputs.submission_file }})
          delimiter=$(openssl rand -hex 8)
          echo "body<<$delimiter" >> $GITHUB_OUTPUT
          echo "$body" >> $GITHUB_OUTPUT
          echo "$delimiter" >> $GITHUB_OUTPUT

      - name: 'Post PR Comment'
        uses: actions/github-script@v7
        if: steps.comment_body.outputs.body != ''
        env:
          COMMENT_BODY: ${{ steps.comment_body.outputs.body }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const body = process.env.COMMENT_BODY;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });