name: 'Validate and Comment on PR'

on:
  pull_request_target:
    types: [opened, synchronize]
    paths:
      - 'rsc/submitted/**'

permissions:
  contents: read
  pull-requests: write

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: 'Blacklist Check'
        id: blacklist_check
        env:
          BLACKLIST: "" # Add comma-separated usernames to ban.
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
        run: |
          echo "PR Author: $PR_AUTHOR"
          if [[ ",$BLACKLIST," == *",$PR_AUTHOR,"* ]]; then
            echo "::error::User $PR_AUTHOR is on the blacklist."
            exit 1
          else
            echo "User $PR_AUTHOR is not on the blacklist."
          fi

      - name: 'Checkout PR Code Safely'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0 # Fetch all history to make base.sha available for git diff

      - name: 'Generate Comment Body'
        id: generate_comment
        run: |
          # Get the list of files changed in the PR
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }})
          SUBMISSION_FILE=$(echo "$CHANGED_FILES" | grep '^rsc/submitted/.*\.json$' | head -n 1)

          if [[ -z "$SUBMISSION_FILE" ]]; then
            echo "comment_body=This PR does not contain a new submission file in \`rsc/submitted/\`." >> "$GITHUB_OUTPUT"
            exit 0
          fi

          SUBMISSION_CONTENT=$(cat "$SUBMISSION_FILE")
          USER_SYSTEM=$(jq -r '.author.system' <<< "$SUBMISSION_CONTENT")
          USER_ID=$(jq -r '.author.id' <<< "$SUBMISSION_CONTENT")

          if [[ "$USER_SYSTEM" == "null" || "$USER_ID" == "null" || -z "$USER_SYSTEM" || -z "$USER_ID" ]]; then
            COMMENT_BODY="### âš ï¸ Submission Error\n\n"
            COMMENT_BODY+="The submission file in this PR appears to be malformed or is from an outdated client.\n\n"
            COMMENT_BODY+="**Error:** Could not find author information (\`.author.system\` or \`.author.id\`) in the submission JSON.\n\n"
            COMMENT_BODY+="**Action Required:** Please close this PR, perform a hard refresh (Ctrl+Shift+R), and try again."
          else
            # Run the Node.js script to get the decoded summary
            DECODED_SUMMARY=$(node scripts/decode-for-validation.mjs "$SUBMISSION_FILE")

            # Construct the verification link
            if [[ "$USER_SYSTEM" == "Email" ]]; then
              VERIFICATION_LINK="mailto:${USER_ID}?subject=Confirm Your Submission"
            elif [[ "$USER_SYSTEM" == "Reddit" ]]; then
              VERIFICATION_LINK="https://www.reddit.com/message/compose?to=${USER_ID}&subject=Confirm%20Your%20Submission"
            else
              VERIFICATION_LINK="https://discord.com/users/${USER_ID}"
            fi

            COMMENT_BODY="### Submission Review Required ðŸ—³ï¸\n\n"
            COMMENT_BODY+="A new submission has been received from **${USER_SYSTEM}** user \`${USER_ID}\`.\n\n"
            COMMENT_BODY+="${DECODED_SUMMARY}\n" # Use the summary from the script
            COMMENT_BODY+="---\n\n#### Reviewer Action\n\nClick here to verify the user: [**Verify via ${USER_SYSTEM}**](${VERIFICATION_LINK})\n\n"
            COMMENT_BODY+="<details><summary>Full Submission Receipt</summary>\n\n\`\`\`json\n${SUBMISSION_CONTENT}\n\`\`\`\n\n</details>" # Raw content for full receipt
          fi

          echo "comment_body<<EOF" >> "$GITHUB_OUTPUT"
          echo -e "$COMMENT_BODY" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: 'Post PR Comment'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: ${{ steps.generate_comment.outputs.comment_body }}
          token: ${{ secrets.GITHUB_TOKEN }}


