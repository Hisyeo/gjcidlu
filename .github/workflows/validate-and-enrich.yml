name: 'Validate and Comment on PR'

on:
  pull_request_target:
    types: [opened, synchronize]
    paths:
      - 'rsc/submitted/**'

permissions:
  contents: read
  pull-requests: write

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: 'Blacklist Check'
        id: blacklist_check
        env:
          BLACKLIST: "" # Add comma-separated usernames to ban.
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
        run: |
          echo "PR Author: $PR_AUTHOR"
          if [[ ",$BLACKLIST," == *",$PR_AUTHOR,"* ]]; then
            echo "::error::User $PR_AUTHOR is on the blacklist."
            exit 1
          else
            echo "User $PR_AUTHOR is not on the blacklist."
          fi

      - name: 'Checkout PR Code Safely'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0 # Fetch all history to make base.sha available for git diff

      - name: 'Generate Comment Body'
        id: generate_comment
        run: |
          # Get the list of files changed in the PR
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }})
          SUBMISSION_FILE=$(echo "$CHANGED_FILES" | grep '^rsc/submitted/.*\.json$' | head -n 1)

          if [[ -z "$SUBMISSION_FILE" ]]; then
            echo "comment_body=This PR does not contain a new submission file in \`rsc/submitted/\`." >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "--- DEBUG: Identified Submission File: $SUBMISSION_FILE ---"
          SUBMISSION_CONTENT=$(cat "$SUBMISSION_FILE")
          echo "$SUBMISSION_CONTENT"

          # Extract values using separate, robust jq calls
          USER_SYSTEM=$(jq -r '.author.system' <<< "$SUBMISSION_CONTENT")
          USER_ID=$(jq -r '.author.id' <<< "$SUBMISSION_CONTENT")
          NEW_TERMS_COUNT=$(jq -r '(.newTerms // []) | length' <<< "$SUBMISSION_CONTENT")
          NEW_ENTRIES_COUNT=$(jq -r '(.newEntries // []) | length' <<< "$SUBMISSION_CONTENT")
          VOTES_COUNT=$(jq -r '(.votes // []) | length' <<< "$SUBMISSION_CONTENT")

          echo "--- DEBUG: Parsed Values ---"
          echo "USER_SYSTEM: $USER_SYSTEM"
          echo "USER_ID: $USER_ID"
          echo "NEW_TERMS_COUNT: $NEW_TERMS_COUNT"
          echo "----------------------------"

          if [[ "$USER_SYSTEM" == "null" || "$USER_ID" == "null" || -z "$USER_SYSTEM" || -z "$USER_ID" ]]; then
            COMMENT_BODY="### âš ï¸ Submission Error\n\n"
            COMMENT_BODY+="The submission file in this PR appears to be malformed or is from an outdated client.\n\n"
            COMMENT_BODY+="**Error:** Could not find author information (\`.author.system\` or \`.author.id\`) in the submission JSON.\n\n"
            COMMENT_BODY+="**Action Required:** Please close this PR, perform a hard refresh (Ctrl+Shift+R), and try again."
          else
            RECEIPT_ITEMS=$(jq -r '
              (
                ((.newTerms // []) | map("- Term '\''\(.id | split("-")[0])'\''")) +
                ((.newEntries // []) | map("- Translation '\''\(.id)'\'' for '\''\(.termId)'\''")) +
                ((.votes // []) | map("- \((.voteType | ascii_upcase[0:1]) + .voteType[1:]) vote for '\''\(.entryId)'\'' on term '\''\(.termId)'\''"))
              ) | .[]
            ' <<< "$SUBMISSION_CONTENT" | sed 's/^/  /')

            if [[ "$USER_SYSTEM" == "Email" ]]; then
              EMAIL_BODY_RAW="Thank you for your ${VOTES_COUNT} votes, ${NEW_ENTRIES_COUNT} entries, and ${NEW_TERMS_COUNT} terms!\n\nHere is a receipt of what you have submitted:\n${RECEIPT_ITEMS}\n\nReply YES if you confirm these votes, entries and terms to be valid.\nReply NO if you would like to start over.\nIf we don't receive a reply in a timely fashion, you may become banned from using email verification."
              ENCODED_EMAIL_BODY=$(python -c 'import urllib.parse; print(urllib.parse.quote(f"""'"$EMAIL_BODY_RAW"'"""))')
              VERIFICATION_LINK="mailto:${USER_ID}?subject=Confirm Your Submission&body=${ENCODED_EMAIL_BODY}"
            elif [[ "$USER_SYSTEM" == "Reddit" ]]; then
              EMAIL_BODY_RAW="Thank you for your ${VOTES_COUNT} votes, ${NEW_ENTRIES_COUNT} entries, and ${NEW_TERMS_COUNT} terms!\n\nHere is a receipt of what you have submitted:\n${RECEIPT_ITEMS}\n\nReply YES if you confirm these votes, entries and terms to be valid.\nReply NO if you would like to start over.\nIf we don't receive a reply in a timely fashion, you may become banned from using Reddit verification."
              ENCODED_EMAIL_BODY=$(python -c 'import urllib.parse; print(urllib.parse.quote(f"""'"$EMAIL_BODY_RAW"'"""))')
              VERIFICATION_LINK="https://www.reddit.com/message/compose?to=${USER_ID}&subject=Confirm%20Your%20Submission&message=${ENCODED_EMAIL_BODY}"
            else
              VERIFICATION_LINK="https://discord.com/users/${USER_ID}"
            fi

            COMMENT_BODY="### Submission Review Required ðŸ—³ï¸\n\n"
            COMMENT_BODY+="A new submission has been received from **${USER_SYSTEM}** user \`${USER_ID}\`.\n\n"
            COMMENT_BODY+="#### Summary of Contributions\n- **New Terms:** ${NEW_TERMS_COUNT}\n- **New Translations:** ${NEW_ENTRIES_COUNT}\n- **New Votes:** ${VOTES_COUNT}\n\n"
            COMMENT_BODY+="---\n\n#### Reviewer Action\n\nClick here to verify the user: [**Verify via ${USER_SYSTEM}**](${VERIFICATION_LINK})\n\n"
            COMMENT_BODY+="<details><summary>Click to see full submission receipt</summary>\n\n${RECEIPT_ITEMS}\n\n</details>"
          fi

          echo "comment_body<<EOF" >> "$GITHUB_OUTPUT"
          echo -e "$COMMENT_BODY" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: 'Post PR Comment'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: ${{ steps.generate_comment.outputs.comment_body }}
          token: ${{ secrets.GITHUB_TOKEN }}


