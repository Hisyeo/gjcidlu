name: 'Validate and Enrich PR'

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - 'rsc/submitted/**'

permissions:
  contents: write
  pull-requests: write # Needed to post comments

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout PR branch'
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.head_ref }}
          fetch-depth: 0 # Fetch all history to resolve refs

      - name: 'Blacklist Check'
        id: blacklist_check
        env:
          # Add comma-separated usernames to ban.
          # e.g., "user1,user2,another-user"
          BLACKLIST: ""
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
        run: |
          echo "PR Author: $PR_AUTHOR"
          if [[ ",$BLACKLIST," == *",$PR_AUTHOR,"* ]]; then
            echo "User $PR_AUTHOR is on the blacklist. Failing."
            echo "validation_status=failed" >> "$GITHUB_OUTPUT"
            exit 1
          else
            echo "User $PR_AUTHOR is not on the blacklist. Proceeding."
            echo "validation_status=passed" >> "$GITHUB_OUTPUT"
          fi
      
      - name: 'Enrich submission file'
        id: enrich_file
        env:
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
        run: |
          SUBMISSION_FILE=$(find rsc/submitted -name '*.json' -print -quit)

          if [[ -z "$SUBMISSION_FILE" ]]; then
            echo "No submission file found in PR. Skipping enrichment."
            echo "enriched_file_path=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Enriching file: $SUBMISSION_FILE"
          
          node -e '
            const fs = require("fs");
            const path = require("path");
            const filePath = process.argv[1];
            const author = process.env.PR_AUTHOR;
            const content = JSON.parse(fs.readFileSync(filePath, "utf-8"));
            content.author = { system: "GitHub", id: author }; // Enriched with GitHub as system
            fs.writeFileSync(filePath, JSON.stringify(content, null, 2));
            console.log(`Successfully added author (${author}) to ${filePath}`);
          ' "$SUBMISSION_FILE"
          echo "enriched_file_path=$SUBMISSION_FILE" >> "$GITHUB_OUTPUT"

      - name: 'Generate Comment Body'
        id: generate_comment
        env:
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
        run: |
          SUBMISSION_FILE="${{ steps.enrich_file.outputs.enriched_file_path }}"
          if [[ -z "$SUBMISSION_FILE" ]]; then
            echo "comment_body=No submission file found in this PR." >> "$GITHUB_OUTPUT"
            exit 0
          fi

          SUBMISSION_CONTENT=$(cat "$SUBMISSION_FILE")
          NEW_TERMS_COUNT=$(echo "$SUBMISSION_CONTENT" | jq '.newTerms | length')
          NEW_ENTRIES_COUNT=$(echo "$SUBMISSION_CONTENT" | jq '.newEntries | length')
          VOTES_COUNT=$(echo "$SUBMISSION_CONTENT" | jq '.votes | length')

          RECEIPT_ITEMS=""
          if [ "$NEW_TERMS_COUNT" -gt 0 ]; then
            RECEIPT_ITEMS+="- **New Terms:** $NEW_TERMS_COUNT\n"
          fi
          if [ "$NEW_ENTRIES_COUNT" -gt 0 ]; then
            RECEIPT_ITEMS+="- **New Translations:** $NEW_ENTRIES_COUNT\n"
          fi
          if [ "$VOTES_COUNT" -gt 0 ]; then
            RECEIPT_ITEMS+="- **New Votes:** $VOTES_COUNT\n"
          fi

          VERIFICATION_LINK="https://github.com/${{ github.repository_owner }}/gjcidlu/pull/${{ github.event.pull_request.number }}" # Link to the PR itself for review

          COMMENT_BODY="### Submission Validation & Review\n\n"
          COMMENT_BODY+="This Pull Request contains a submission from GitHub user **${{ env.PR_AUTHOR }}**.\n\n"
          COMMENT_BODY+="**Summary of Contributions:**\n${RECEIPT_ITEMS}\n"
          COMMENT_BODY+="Please review the changes in this PR. The submission file has been enriched with the author's GitHub ID.\n\n"
          COMMENT_BODY+="[Click here to review the PR]($VERIFICATION_LINK)\n"
          
          echo "comment_body<<EOF" >> "$GITHUB_OUTPUT"
          echo "$COMMENT_BODY" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: 'Post PR Comment'
        uses: peter-evans/create-or-update-comment@v3
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: ${{ steps.generate_comment.outputs.comment_body }}
          token: ${{ secrets.GITHUB_TOKEN }}
