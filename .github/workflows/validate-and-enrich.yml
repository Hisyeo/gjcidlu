name: 'Validate and Comment on PR'

on:
  pull_request_target:
    types: [opened, synchronize]
    paths:
      - 'rsc/submitted/**'

permissions:
  contents: write
  pull-requests: write

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: 'Blacklist Check'
        id: blacklist_check
        env:
          BLACKLIST: "" # Add comma-separated usernames to ban.
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
        run: |
          echo "PR Author: $PR_AUTHOR"
          if [[ ",$BLACKLIST," == *",$PR_AUTHOR,"* ]]; then
            echo "::error::User $PR_AUTHOR is on the blacklist."
            exit 1
          else
            echo "User $PR_AUTHOR is not on the blacklist."
          fi

      - name: 'Checkout PR Code Safely'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0 # Fetch all history to make base.sha available for git diff

      - name: 'Check for Duplicate Entries'
        id: duplicate_check
        run: |
          # Get the list of files changed in the PR
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }})
          SUBMISSION_FILE=$(echo "$CHANGED_FILES" | grep '^rsc/submitted/.*\.json$' | head -n 1)

          if [[ -z "$SUBMISSION_FILE" ]]; then
            exit 0
          fi

          # Run the duplicate check script
          node scripts/check-duplicates.mjs "$SUBMISSION_FILE" >> "$GITHUB_OUTPUT"

      - name: Create Check Run
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [[ "${{ steps.duplicate_check.outputs.duplicate_found }}" == "true" ]]; then
            CONCLUSION="action_required"
            TITLE="Duplicate Entry Found"
            SUMMARY="Your translation **${{ steps.duplicate_check.outputs.duplicate_entry_id }}** has already been submitted in another pending submission."
            TEXT="Please choose one of the following options:"
            ACTIONS='[
              {"label": "Change to Vote", "description": "Change this entry to a vote.", "identifier": "change-to-vote"},
              {"label": "Remove Entry", "description": "Remove this entry from your submission.", "identifier": "remove-entry"},
              {"label": "Rerun Check", "description": "Rerun the validation check.", "identifier": "rerun-check"}
            ]'
          else
            CONCLUSION="success"
            TITLE="Validation Successful"
            SUMMARY="No duplicate entries found."
            TEXT="This submission is ready for review."
            ACTIONS="[]"
          fi

          curl -L \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${{ github.repository }}/check-runs" \
            -d '{
              "name": "Duplicate Entry Check",
              "head_sha": "${{ github.event.pull_request.head.sha }}",
              "status": "completed",
              "conclusion": "'"$CONCLUSION"'",
              "output": {
                "title": "'"$TITLE"'",
                "summary": "'"$SUMMARY"'",
                "text": "'"$TEXT"'"
              },
              "actions": '"$ACTIONS"'
            }'
